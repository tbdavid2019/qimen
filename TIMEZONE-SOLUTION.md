# 時區問題修正總結

## 🔧 修正內容

### 1. 前端增強 (`public/js/app.js`)
- 改進時區檢測邏輯，支援時區變化檢測
- 增加時間戳過期檢測（防止長時間使用造成的偏差）
- 添加視覺化時區狀態指示器
- 增強模式切換時的時區參數保持

### 2. 後端優化 (`app.js`)
- 簡化時區處理邏輯，提高穩定性
- 增加詳細的時區調試日誌
- 新增時區調試 API：`/api/timezone-debug`

### 3. Vercel 配置 (`vercel.json`)
- 明確設定服務器時區為 UTC
- 確保部署環境的一致性

### 4. 測試工具
- 新增 `test-timezone.js` 腳本
- 可本地測試時區計算邏輯

## 🚀 部署步驟

1. **提交代碼**
```bash
git add .
git commit -m "修正時區問題 - 增強檢測和穩定性"
git push origin main
```

2. **Vercel 自動部署**
- Vercel 會自動檢測到代碼變更並重新部署
- 新的 `vercel.json` 配置會確保 UTC 時區設定

3. **測試驗證**
- 訪問主頁 `/` 檢查時區是否正確
- 訪問 `/start` 測試儀式感頁面
- 檢查本地時間顯示是否為綠色（表示正常）

## 🔍 測試方法

### 本地測試
```bash
# 運行時區測試腳本
node test-timezone.js

# 啟動應用
npm start

# 訪問調試 API
curl http://localhost:3000/api/timezone-debug
```

### 生產環境測試
- 訪問 `https://your-vercel-app.vercel.app/`
- 檢查頁面上的「本地時間」是否正確
- 綠色 = 正常，紅色 = 異常
- 可訪問 `/api/timezone-debug` 查看詳細信息

## 📝 技術原理

### 問題根源
之前的方案依賴時間戳，但時間戳在不同時區的伺服器上會有不同的解釋：
- 本地開發：時間戳 → 本地時間顯示  
- Vercel (UTC)：同樣的時間戳 → UTC 時間顯示

### 新解決方案
1. **主要方法**：前端傳遞格式化時間字串 `userDateTime`
   - 格式：`2025-08-04T19:56:53`（用戶的實際本地時間）
   - 後端直接解析，無時區轉換問題

2. **備用方法**：時間戳 + 時區偏移計算
   - 當檢測到時間戳參數時
   - 根據用戶時區偏移調整顯示時間

3. **實作細節**：
   - 前端自動檢測：每次頁面載入時檢查時區參數
   - 智能更新：檢測到變化時自動重新載入
   - 後端適配：優先使用前端時間，備用時區轉換
   - 防止偏差：定期更新時間戳避免長時間使用誤差

### Vercel 部署說明
- Vercel 預設使用 UTC 時區，無需額外配置
- 不支援設定 `TZ` 環境變數
- 我們的代碼已經適配 UTC 環境

## ✅ 預期效果

- 任何時區的用戶都能看到正確的奇門遁甲排盤
- Vercel 部署環境與本地開發環境計算結果一致
- 用戶無感知的自動時區調整
- 支援夏令時等時區變化
